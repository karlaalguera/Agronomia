<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Malla Curricular Agronomía UCR</title>
<style>
  /* RESET */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8fafb;
    margin: 0;
    padding: 1rem;
    color: #2c3e50;
  }
  h1, h2, h3 {
    margin: 0.5rem 0 1rem 0;
  }
  /* CONTENEDOR GENERAL */
  .container {
    max-width: 1200px;
    margin: auto;
  }
  /* Encabezado */
  header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  /* Layout columnas por año */
  .years {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }
  .year-column {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 6px rgb(0 0 0 / 0.1);
    min-width: 260px;
    display: flex;
    flex-direction: column;
    padding: 1rem;
  }
  .year-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #34495e;
    border-bottom: 2px solid #a3c4bc;
    padding-bottom: 0.4rem;
  }
  /* Semestres */
  .semester {
    margin-bottom: 1rem;
  }
  .semester-title {
    font-weight: 600;
    margin-bottom: 0.6rem;
    color: #557a7f;
  }
  /* Materias */
  .course-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .course {
    background: #d7e6e0;
    border-radius: 5px;
    padding: 0.45rem 0.6rem;
    cursor: pointer;
    position: relative;
    font-size: 0.9rem;
    color: #2c3e50;
    user-select: none;
    border: 2px solid transparent;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .course.approved {
    background: #a4d7a7;
    color: #2f4f25;
    font-weight: 700;
    border-color: #3b6e15;
    cursor: default;
  }
  .course.locked {
    background: #ececec;
    color: #8a8a8a;
    cursor: default;
    border-color: #ccc;
  }
  .course.locked:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 105%;
    top: 50%;
    transform: translateY(-50%);
    background: #34495e;
    color: white;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    white-space: nowrap;
    font-size: 0.75rem;
    box-shadow: 0 0 4px rgba(0,0,0,0.4);
    z-index: 10;
  }
  /* Apartado créditos */
  #credits-summary {
    background: #ffffff;
    margin-top: 1.5rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 8px rgb(0 0 0 / 0.1);
    font-size: 1.1rem;
    font-weight: 600;
    color: #31708f;
    user-select: none;
  }
  /* Scroll barra en años */
  .years::-webkit-scrollbar {
    height: 8px;
  }
  .years::-webkit-scrollbar-thumb {
    background-color: #a3c4bc;
    border-radius: 4px;
  }
  /* Responsive */
  @media (max-width: 900px) {
    .years {
      flex-wrap: nowrap;
    }
    .year-column {
      min-width: 240px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Malla Curricular Agronomía - UCR</h1>
    <p>Marca los cursos aprobados. Los cursos bloqueados requieren aprobar los prerrequisitos.</p>
  </header>
  <div class="years" id="years-container">
    <!-- Columnas generadas con JS -->
  </div>
  <div id="credits-summary">
    Créditos aprobados: <span id="credits-earned">0</span> / 179
  </div>
</div>

<script>
(() => {
  const totalCredits = 179;

  const malla = [
    {
      yearName: "Bachillerato - Primer año",
      semesters: [
        {
          semName: "I semestre",
          courses: [
            { code:"B0106", name:"Biología General", credits:3, opens:["B0111"] },
            { code:"B0107", name:"Laboratorio de Biología General", credits:1, opens:["B0111"] },
            { code:"EF", name:"Actividad deportiva", credits:0, opens:[] },
            { code:"EG-I", name:"Humanidades I", credits:6, opens:["EG-II"] },
            { code:"MA1210", name:"Cálculo I", credits:3, opens:["AF0104"] },
            { code:"QU0114", name:"Química General Intensiva Lab. Química General Intensiva", credits:4, opens:["QU0200","QU0210"] },
            { code:"QU0115", name:"Lab. Química General Intensiva", credits:1, opens:["QU0201","QU0211"] },
          ]
        },
        {
          semName: "II semestre",
          courses: [
            { code:"B0111", name:"Botánica Agrícola I", credits:4, opens:["AF0106","AF0105","AF0107"] },
            { code:"EG-II", name:"Humanidades II", credits:6, opens:["SR-I"] },
            { code:"QU0200", name:"Química Analítica Cuantitativa I", credits:3, opens:["AF0206"] },
            { code:"QU0201", name:"Lab. Química Analítica Cuantitativa I", credits:2, opens:["AF0105","AF0206"] },
            { code:"QU0210", name:"Fundamentos de Química Orgánica", credits:4, opens:["AF0105","AF0107"] },
            { code:"QU0211", name:"Lab. Fundamentos de Química Orgánica", credits:1, opens:["AF0105","AF0107"] },
          ]
        },
        {
          semName: "III Semestre (verano)",
          courses: [
            { code:"AF0104", name:"Métodos de investigación Agrícola", credits:4, opens:["AF0105","AF0107","AF0206"] },
            { code:"AF0106", name:"Práctica Agrícola I", credits:2, opens:[] },
          ]
        }
      ]
    },
    {
      yearName: "Segundo año",
      semesters: [
        {
          semName: "IV Semestre",
          courses: [
            { code:"EG", name:"Curso de Arte", credits:2, opens:[] },
            { code:"AF0105", name:"Fisiología vegetal", credits:5, opens:["AF0111","AF0109","AF0110","AF0108","AF0112"] },
            { code:"AF0107", name:"Fitogenética", credits:4, opens:["AF0111","AF0109","AF0110","AF0108"] },
            { code:"AF0108", name:"Relación suelo-planta", credits:3, opens:["AF0108","AF0112"] },
            { code:"FS0103", name:"Física para Ciencias de la Vida I", credits:3, opens:["AF0116"] },
          ]
        },
        {
          semName: "V Semestre",
          courses: [
            { code:"AF0111", name:"Biología de Malezas", credits:4, opens:["AF0113"] },
            { code:"AF0109", name:"Fitopatología", credits:2, opens:["AF0113"] },
            { code:"AF0110", name:"Entomología Agrícola", credits:2, opens:["AF0113"] },
            { code:"AF0108", name:"Agroecología", credits:2, opens:["AF0113","AF0114"] },
            { code:"AF0112", name:"Productividad de suelos", credits:3, opens:["AF0119","AF0116"] },
          ]
        },
        {
          semName: "VI Semestre (verano)",
          courses: [
            { code:"AF0113", name:"Práctica Agrícola II", credits:2, opens:["AF3410","AF0118"] },
            { code:"AF0114", name:"Elementos de Economía Agrícola", credits:3, opens:["AF0201"] },
          ]
        }
      ]
    },
    {
      yearName: "Tercer Año",
      semesters: [
        {
          semName: "VII Semestre",
          courses: [
            { code:"SR-I", name:"Seminario Realidad Nacional I", credits:2, opens:["SR-II"] },
            { code:"AF3410", name:"Fisiología de los Cultivos", credits:4, opens:["AF0117"] },
            { code:"AF0118", name:"Manejo Integrado de Problemas Fitosanitarios", credits:4, opens:["AF0117","AF0202"] },
            { code:"AF0119", name:"Conservación de Suelos", credits:3, opens:["AF0115"] },
            { code:"AF0116", name:"Manejo de Aguas Agrícolas", credits:2, opens:["AF0115"] },
            { code:"AF0201", name:"Gestión y Administración de Empresas Agrícolas", credits:4, opens:["AF0117","AF0202"] },
          ]
        },
        {
          semName: "VIII Semestre",
          courses: [
            { code:"SR-II", name:"Seminario Realidad Nacional II", credits:2, opens:[] },
            { code:"OPT951", name:"Optativos del Plan de Bachillerato y Licenciatura", credits:4, opens:[] },
            { code:"AF0117", name:"Sistemas de Producción de Cultivos", credits:4, opens:["AF0212","AF0206"] },
            { code:"AF0115", name:"Equipos Agrícolas y Mecanización", credits:2, opens:[] },
            { code:"AF0202", name:"Práctica Agrícola III", credits:4, opens:["AF0206"] },
          ]
        }
      ]
    },
    {
      yearName: "Cuarto año",
      semesters: [
        {
          semName: "IX Semestre",
          courses: [
            { code:"RP", name:"Repertorio", credits:3, opens:[] },
            { code:"AF0212", name:"Diseño de Experimentos I", credits:3, opens:["AF0220"] },
            { code:"AF0206", name:"Proyecto Productivo", credits:6, opens:["AF0207"] },
            { code:"OPT951", name:"Optativos del Plan de Bachillerato y Licenciatura", credits:4, opens:[] },
          ]
        },
        {
          semName: "X Semestre",
          courses: [
            { code:"AF0220", name:"Taller de Formulación de Proyectos", credits:2, opens:["AF0221","AF0222"] },
            { code:"AF0207", name:"Pasantía", credits:12, opens:["AF0221","AF5413"] },
          ]
        }
      ]
    },
    {
      yearName: "Licenciatura - Quinto año",
      semesters: [
        {
          semName: "XI Semestre",
          courses: [
            { code:"AF0221", name:"Taller de Investigación I", credits:6, opens:["AF0222"] },
            { code:"OPT951", name:"Optativos del Plan de Bachillerato y Licenciatura", credits:11, opens:[] },
          ]
        },
        {
          semName: "XII Semestre",
          courses: [
            { code:"AF0222", name:"Taller de Investigación II", credits:6, opens:[] },
            { code:"AF5413", name:"Seminario de Agronomía", credits:1, opens:[] },
            { code:"OPT951", name:"Optativos del Plan de Bachillerato y Licenciatura", credits:11, opens:[] },
          ]
        },
        {
          semName: "XIII Semestre",
          courses: [
            { code:"AF9500", name:"INVESTIGACION DIRIGIDA 1", credits:0, opens:["AF9600","AF9501","AF9601","AF9602","AF9700","AF9701","AF9702"] },
            { code:"AF9600", name:"SEMINARIO DE GRADUACION 1", credits:0, opens:[] },
            { code:"AF9601", name:"SEMINARIO DE GRADUACION 2", credits:0, opens:[] },
            { code:"AF9602", name:"SEMINARIO DE GRADUACION 3", credits:0, opens:[] },
            { code:"AF9700", name:"PRÁCTICA DIRIGIDA I", credits:0, opens:["AF9701"] },
            { code:"AF9701", name:"PRÁCTICA DIRIGIDA II", credits:0, opens:["AF9702"] },
            { code:"AF9702", name:"PRÁCTICA DIRIGIDA III", credits:0, opens:[] },
          ]
        },
        {
          semName: "XIV Semestre",
          courses: [
            { code:"AF9501", name:"INVESTIGACION DIRIGIDA 2", credits:0, opens:[] },
          ]
        }
      ]
    }
  ];

  // Crear mapa de prerrequisitos (materias que desbloquean cada materia)
  const prereqMap = {};
  for (const year of malla) {
    for (const sem of year.semesters) {
      for (const c of sem.courses) {
        prereqMap[c.code] = [];
      }
    }
  }
  for (const year of malla) {
    for (const sem of year.semesters) {
      for (const c of sem.courses) {
        for (const openCode of c.opens) {
          if (prereqMap[openCode]) {
            prereqMap[openCode].push(c.code);
          }
        }
      }
    }
  }

  let approved = new Set();

  function loadProgress() {
    try {
      const saved = localStorage.getItem("mallaAprobados");
      if (saved) {
        const arr = JSON.parse(saved);
        approved = new Set(arr);
      }
    } catch {
      approved = new Set();
    }
  }

  function saveProgress() {
    localStorage.setItem("mallaAprobados", JSON.stringify(Array.from(approved)));
  }

  function isUnlocked(code) {
    const prereqs = prereqMap[code] || [];
    return prereqs.every(pr => approved.has(pr));
  }

  function updateCredits() {
    let sum = 0;
    for (const code of approved) {
      for (const year of malla) {
        for (const sem of year.semesters) {
          for (const c of sem.courses) {
            if (c.code === code && c.credits > 0) {
              sum += c.credits;
            }
          }
        }
      }
    }
    document.getElementById("credits-earned").textContent = sum;
  }

  function createCourseElement(course) {
    const div = document.createElement("div");
    div.className = "course";
    div.textContent = course.code + " " + course.name;
    div.dataset.code = course.code;

    if (approved.has(course.code)) {
      div.classList.add("approved");
    } else if (!isUnlocked(course.code)) {
      div.classList.add("locked");

      const missing = prereqMap[course.code].filter(pr => !approved.has(pr));
      if (missing.length > 0) {
        div.dataset.tooltip = "Falta aprobar: " + missing.join(", ");
      } else {
        div.dataset.tooltip = "Bloqueado";
      }
    }

    div.addEventListener("click", () => {
      if (div.classList.contains("locked")) return;
      if (div.classList.contains("approved")) {
        approved.delete(course.code);
      } else {
        approved.add(course.code);
      }
      saveProgress();
      renderMalla();
    });

    return div;
  }

  function renderMalla() {
    const container = document.getElementById("years-container");
    container.innerHTML = "";

    for (const year of malla) {
      const yearCol = document.createElement("div");
      yearCol.className = "year-column";

      const yTitle = document.createElement("div");
      yTitle.className = "year-title";
      yTitle.textContent = year.yearName;
      yearCol.appendChild(yTitle);

      for (const sem of year.semesters) {
        const semDiv = document.createElement("div");
        semDiv.className = "semester";

        const semTitle = document.createElement("div");
        semTitle.className = "semester-title";
        semTitle.textContent = sem.semName;
        semDiv.appendChild(semTitle);

        const courseList = document.createElement("div");
        courseList.className = "course-list";

        for (const course of sem.courses) {
          const courseEl = createCourseElement(course);
          courseList.appendChild(courseEl);
        }

        semDiv.appendChild(courseList);
        yearCol.appendChild(semDiv
